<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üßØ Fire Extinguisher QA Quiz - ‡∏£‡∏û.‡∏™‡∏ï.‡∏™‡∏∞‡∏Å‡∏≤‡∏î</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Chart.js for dashboard -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: "Noto Sans Thai", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    .card { @apply bg-white rounded-2xl shadow-xl p-5; }
    .badge { @apply rounded-full px-3 py-1 text-sm font-semibold; }
    .tab-active { @apply bg-red-500 text-white; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-rose-50 via-orange-50 to-amber-50">
  <div id="app" class="max-w-6xl mx-auto p-4 md:p-8">
    <header class="flex items-center justify-between gap-4 mb-6">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-2xl bg-red-500 flex items-center justify-center shadow-lg">
          <span class="text-2xl">üßØ</span>
        </div>
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold text-red-600">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ñ‡∏±‡∏á‡∏î‡∏±‡∏ö‡πÄ‡∏û‡∏•‡∏¥‡∏á</h1>
          <p class="text-sm md:text-base text-slate-600">‡∏£‡∏û.‡∏™‡∏ï.‡∏™‡∏∞‡∏Å‡∏≤‡∏î ‚Ä¢ Fire Extinguisher QA Quiz</p>
        </div>
      </div>
      <div id="userBox" class="hidden md:flex items-center gap-3">
        <span id="userRole" class="badge bg-amber-100 text-amber-700">-</span>
        <span id="userName" class="font-semibold text-slate-700">-</span>
        <button id="btnLogout" class="ml-2 px-3 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </header>

    <!-- LOGIN -->
    <section id="loginSection" class="card max-w-md mx-auto">
      <h2 class="text-xl font-bold text-slate-800 mb-4">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
      <p class="text-slate-600 mb-3">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á):</p>
      <ul class="text-sm text-slate-600 mb-4 list-disc pl-6">
        <li><b>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• (admin)</b> ‚Ä¢ ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: <code>admin</code> ‡∏£‡∏´‡∏±‡∏™: <code>admin123</code></li>
        <li><b>‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (inspector)</b> ‚Ä¢ ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: <code>inspector</code> ‡∏£‡∏´‡∏±‡∏™: <code>1234</code></li>
      </ul>
      <div class="grid gap-3">
        <input id="loginUser" class="border rounded-xl px-4 py-3" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" />
        <input id="loginPass" type="password" class="border rounded-xl px-4 py-3" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" />
        <button id="btnLogin" class="w-full py-3 rounded-xl bg-red-500 text-white font-bold hover:bg-red-600">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </section>

    <!-- MAIN APP -->
    <section id="mainSection" class="hidden">
      <!-- TABS -->
      <div class="flex flex-wrap gap-2 mb-4">
        <button data-tab="quiz" class="tabBtn px-4 py-2 rounded-xl bg-white shadow hover:bg-rose-50">‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à</button>
        <button data-tab="dashboard" class="tabBtn px-4 py-2 rounded-xl bg-white shadow hover:bg-rose-50">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</button>
        <button data-tab="records" class="tabBtn px-4 py-2 rounded-xl bg-white shadow hover:bg-rose-50">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</button>
        <button data-tab="manage" class="tabBtn px-4 py-2 rounded-xl bg-white shadow hover:bg-rose-50">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</button>
      </div>

      <!-- QUIZ TAB -->
      <div id="tab-quiz" class="card">
        <div class="grid md:grid-cols-3 gap-4 mb-6">
          <div>
            <label class="text-sm text-slate-600">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ñ‡∏±‡∏á / ‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</label>
            <input id="fxId" class="border rounded-xl px-4 py-2 w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô SKD-01-001" />
          </div>
          <div>
            <label class="text-sm text-slate-600">‡∏à‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á / ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</label>
            <input id="fxLocation" class="border rounded-xl px-4 py-2 w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô" />
          </div>
          <div>
            <label class="text-sm text-slate-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ñ‡∏±‡∏á</label>
            <select id="fxType" class="border rounded-xl px-4 py-2 w-full">
              <option>‡∏ú‡∏á‡πÄ‡∏Ñ‡∏°‡∏µ‡πÅ‡∏´‡πâ‡∏á (Dry Chemical)</option>
              <option>CO‚ÇÇ</option>
              <option>Foam</option>
              <option>Water</option>
              <option>‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
            </select>
          </div>
        </div>

        <div id="questionsBox" class="space-y-4"></div>

        <button id="btnSave" class="mt-6 w-full md:w-auto px-6 py-3 rounded-xl bg-green-500 text-white font-bold hover:bg-green-600">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</button>
        <p id="saveMsg" class="mt-3 text-green-700 font-medium hidden">‚úîÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
      </div>

      <!-- DASHBOARD TAB -->
      <div id="tab-dashboard" class="card hidden">
        <div class="grid md:grid-cols-3 gap-4 mb-4">
          <div class="p-4 rounded-2xl bg-emerald-50 border border-emerald-200">
            <p class="text-slate-600">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ú‡πà‡∏≤‡∏ô</p>
            <p id="kpiPassRate" class="text-3xl font-extrabold text-emerald-700">-</p>
          </div>
          <div class="p-4 rounded-2xl bg-rose-50 border border-rose-200">
            <p class="text-slate-600">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô</p>
            <p id="kpiFailRate" class="text-3xl font-extrabold text-rose-700">-</p>
          </div>
          <div class="p-4 rounded-2xl bg-amber-50 border border-amber-200">
            <p class="text-slate-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</p>
            <p id="kpiTotal" class="text-3xl font-extrabold text-amber-700">-</p>
          </div>
        </div>
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <h3 class="font-bold mb-2">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à</h3>
            <canvas id="chartPie"></canvas>
          </div>
          <div>
            <h3 class="font-bold mb-2">‡∏Ç‡πâ‡∏≠‡∏ö‡∏Å‡∏û‡∏£‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h3>
            <canvas id="chartBar"></canvas>
          </div>
        </div>
      </div>

      <!-- RECORDS TAB -->
      <div id="tab-records" class="card hidden">
        <div class="flex items-center justify-between gap-3 mb-3">
          <h3 class="text-xl font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</h3>
          <div class="flex gap-2">
            <button id="btnExportXLSX" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
            <button id="btnClear" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-800 hover:bg-slate-300">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="bg-slate-100 text-slate-700">
                <th class="p-2 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                <th class="p-2 text-left">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à</th>
                <th class="p-2 text-left">‡∏£‡∏´‡∏±‡∏™‡∏ñ‡∏±‡∏á</th>
                <th class="p-2 text-left">‡∏à‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</th>
                <th class="p-2 text-left">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                <th class="p-2 text-left">‡∏™‡∏£‡∏∏‡∏õ</th>
                <th class="p-2 text-left">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô (‡∏¢‡πà‡∏≠)</th>
              </tr>
            </thead>
            <tbody id="recordsBody"></tbody>
          </table>
        </div>
      </div>

      <!-- MANAGE TAB -->
      <div id="tab-manage" class="card hidden">
        <h3 class="text-xl font-bold mb-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</h3>
        <div class="grid md:grid-cols-2 gap-6">
          <div class="p-4 rounded-2xl border">
            <h4 class="font-semibold mb-2">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h4>
            <p class="text-sm text-slate-600 mb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>
            <div class="grid grid-cols-2 gap-3">
              <input id="newUser" class="border rounded-xl px-3 py-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" />
              <input id="newPass" class="border rounded-xl px-3 py-2" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" />
              <select id="newRole" class="border rounded-xl px-3 py-2">
                <option value="inspector">inspector</option>
                <option value="admin">admin</option>
              </select>
              <button id="btnAddUser" class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
            </div>
            <div class="mt-4">
              <h5 class="font-semibold mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h5>
              <ul id="userList" class="space-y-1 text-sm"></ul>
            </div>
          </div>
          <div class="p-4 rounded-2xl border">
            <h4 class="font-semibold mb-2">‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
            <div class="flex flex-wrap gap-2">
              <button id="btnBackupJson" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î JSON</button>
              <input id="restoreFile" type="file" accept=".json" class="hidden" />
              <button id="btnRestoreJson" class="px-4 py-2 rounded-xl bg-amber-500 text-white hover:bg-amber-600">‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå JSON</button>
            </div>
            <p class="text-xs text-slate-500 mt-2">‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</p>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ------------------ DATA & CONSTANTS ------------------
    const QUESTIONS = [
      "‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢/‡πÑ‡∏°‡πà‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢",
      "‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢ ‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á ‡∏£‡∏∞‡∏¢‡∏∞‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô",
      "‡∏õ‡πâ‡∏≤‡∏¢‡∏ö‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á/‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ä‡∏ô‡∏¥‡∏î‡∏ñ‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡∏∞‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î",
      "‡∏ã‡∏µ‡∏•/‡∏•‡∏ß‡∏î‡∏•‡πá‡∏≠‡∏Å & ‡∏™‡∏•‡∏±‡∏Å‡∏ô‡∏¥‡∏£‡∏†‡∏±‡∏¢ (Safety Pin) ‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏£‡∏ö ‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∏‡∏î ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡∏≠‡∏≠‡∏Å",
      "‡πÄ‡∏Å‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô (‡∏ñ‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏Å‡∏à) ‡∏ä‡∏µ‡πâ‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß",
      "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å/‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ñ‡∏±‡∏á CO‚ÇÇ ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Å‡∏à) ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏µ‡πâ ‚Äú‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‚Äù",
      "‡∏™‡∏≤‡∏¢‡∏â‡∏µ‡∏î/‡∏´‡∏±‡∏ß‡∏â‡∏µ‡∏î/‡πÄ‡∏Ç‡πá‡∏°‡∏Ç‡∏±‡∏î‡∏¢‡∏∂‡∏î ‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏£‡∏ö ‡πÑ‡∏°‡πà‡∏≠‡∏∏‡∏î‡∏ï‡∏±‡∏ô ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏Å‡∏£‡πâ‡∏≤‡∏ß",
      "‡∏™‡∏†‡∏≤‡∏û‡∏ï‡∏±‡∏ß‡∏ñ‡∏±‡∏á ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≠‡∏¢‡∏ö‡∏∏‡∏ö ‡∏•‡∏±‡∏Å‡∏¢‡∏¥‡πâ‡∏° ‡∏™‡∏ô‡∏¥‡∏° ‡∏Å‡∏£‡πà‡∏≠‡∏ô ‡∏£‡∏≠‡∏¢‡∏£‡πâ‡∏≤‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡∏¢‡∏£‡∏±‡πà‡∏ß",
      "‡∏ï‡∏±‡∏ß‡∏¢‡∏∂‡∏î/‡∏Ç‡∏≤‡∏¢‡∏∂‡∏î/‡∏ï‡∏π‡πâ‡πÄ‡∏Å‡πá‡∏ö ‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á ‡πÅ‡∏ô‡πà‡∏ô‡∏´‡∏ô‡∏≤ ‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏ï‡∏π‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢",
      "‡∏â‡∏•‡∏≤‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ & ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ä‡∏±‡∏î ‡πÑ‡∏°‡πà‡∏ã‡∏µ‡∏î‡∏à‡∏≤‡∏á/‡∏´‡∏•‡∏∏‡∏î‡∏•‡∏≠‡∏Å",
      "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡πà‡∏≠‡∏á‡∏£‡∏≠‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏á‡∏´‡∏•‡∏∏‡∏î/‡∏´‡∏±‡∏ß‡∏â‡∏µ‡∏î‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô/‡∏ï‡∏∞‡∏Å‡∏≠‡∏ô",
      "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÇ‡∏î‡∏¢‡∏£‡∏≠‡∏ö ‡∏õ‡∏£‡∏≤‡∏®‡∏à‡∏≤‡∏Å‡∏™‡∏¥‡πà‡∏á‡∏™‡∏Å‡∏õ‡∏£‡∏Å/‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡∏™‡∏≤‡∏£‡∏Å‡∏±‡∏î‡∏Å‡∏£‡πà‡∏≠‡∏ô",
      "‡πÅ‡∏ó‡πá‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à ‡∏°‡∏µ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à"
    ];

    const LS_USERS = "feq_users";
    const LS_RECORDS = "feq_records";
    const LS_SESSION = "feq_session";

    function loadUsers() {
      const json = localStorage.getItem(LS_USERS);
      if (json) return JSON.parse(json);
      const defaults = [
        { username: "admin", password: "admin123", role: "admin" },
        { username: "inspector", password: "1234", role: "inspector" },
      ];
      localStorage.setItem(LS_USERS, JSON.stringify(defaults));
      return defaults;
    }

    function saveUsers(users) {
      localStorage.setItem(LS_USERS, JSON.stringify(users));
    }

    function getSession() {
      const s = localStorage.getItem(LS_SESSION);
      return s ? JSON.parse(s) : null;
    }

    function setSession(sess) {
      localStorage.setItem(LS_SESSION, JSON.stringify(sess));
    }

    function signOut() {
      localStorage.removeItem(LS_SESSION);
      location.reload();
    }

    function loadRecords() {
      const json = localStorage.getItem(LS_RECORDS);
      return json ? JSON.parse(json) : [];
    }

    function saveRecord(record) {
      const all = loadRecords();
      all.push(record);
      localStorage.setItem(LS_RECORDS, JSON.stringify(all));
    }

    // ------------------ UI HELPERS ------------------
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    function switchTab(name) {
      $$(".tabBtn").forEach(b => b.classList.remove("tab-active"));
      $$("[id^='tab-']").forEach(v => v.classList.add("hidden"));
      document.querySelector(`[data-tab='${name}']`).classList.add("tab-active");
      $(`#tab-${name}`).classList.remove("hidden");
      if (name === "dashboard") drawDashboard();
      if (name === "records") renderRecords();
      if (name === "manage") renderUsers();
    }

    // ------------------ LOGIN ------------------
    function doLogin() {
      const u = $("#loginUser").value.trim();
      const p = $("#loginPass").value.trim();
      const users = loadUsers();
      const found = users.find(x => x.username === u && x.password === p);
      if (!found) {
        alert("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        return;
      }
      const session = { username: found.username, role: found.role, loginAt: new Date().toISOString() };
      setSession(session);
      afterLogin(session);
    }

    function afterLogin(sess) {
      $("#loginSection").classList.add("hidden");
      $("#mainSection").classList.remove("hidden");
      $("#userBox").classList.remove("hidden");
      $("#userName").textContent = sess.username;
      $("#userRole").textContent = sess.role;
      switchTab("quiz");
    }

    // ------------------ QUIZ RENDER ------------------
    function renderQuestions() {
      const box = $("#questionsBox");
      box.innerHTML = "";
      QUESTIONS.forEach((q, i) => {
        const idPass = `q${i}_pass`;
        const idFail = `q${i}_fail`;
        const idNote = `q${i}_note`;
        const wrap = document.createElement("div");
        wrap.className = "p-4 rounded-2xl border bg-white/70";
        wrap.innerHTML = `
          <p class="font-medium text-slate-800">${i + 1}. ${q}</p>
          <div class="flex flex-wrap gap-6 mt-2">
            <label class="flex items-center gap-2 text-green-700">
              <input id="${idPass}" type="radio" name="q${i}" class="accent-green-600" />
              ‚òë ‡∏ú‡πà‡∏≤‡∏ô
            </label>
            <label class="flex items-center gap-2 text-rose-700">
              <input id="${idFail}" type="radio" name="q${i}" class="accent-rose-600" />
              ‚òê ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô
            </label>
          </div>
          <textarea id="${idNote}" class="w-full mt-3 p-3 border rounded-xl hidden" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ / ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô')"></textarea>
        `;
        box.appendChild(wrap);
        const passEl = wrap.querySelector(`#${idPass}`);
        const failEl = wrap.querySelector(`#${idFail}`);
        const noteEl = wrap.querySelector(`#${idNote}`);
        passEl.addEventListener("change", () => { if (passEl.checked) noteEl.classList.add("hidden"); });
        failEl.addEventListener("change", () => { if (failEl.checked) noteEl.classList.remove("hidden"); noteEl.focus(); });
      });
    }

    function collectAnswers() {
      const answers = [];
      const notes = [];
      for (let i = 0; i < QUESTIONS.length; i++) {
        const pass = document.querySelector(`#q${i}_pass`).checked;
        const fail = document.querySelector(`#q${i}_fail`).checked;
        let ans = null;
        if (pass) ans = "‡∏ú‡πà‡∏≤‡∏ô";
        else if (fail) ans = "‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô";
        const note = document.querySelector(`#q${i}_note`).value.trim();
        if (ans === "‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô" && !note) {
          alert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${i + 1}`);
          return null;
        }
        answers.push(ans);
        notes.push(note);
      }
      if (answers.some(a => a === null)) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
        return null;
      }
      return { answers, notes };
    }

    function handleSave() {
      const sess = getSession();
      if (!sess) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö");
      const info = collectAnswers();
      if (!info) return;
      const fxId = $("#fxId").value.trim();
      const fxLocation = $("#fxLocation").value.trim();
      const fxType = $("#fxType").value;
      const passCount = info.answers.filter(a => a === "‡∏ú‡πà‡∏≤‡∏ô").length;
      const failCount = info.answers.filter(a => a === "‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô").length;
      const summary = failCount === 0 ? "‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" : `‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ${failCount} ‡∏Ç‡πâ‡∏≠`;

      const rec = {
        id: crypto.randomUUID(),
        date: new Date().toISOString(),
        inspector: sess.username,
        fxId, fxLocation, fxType,
        answers: info.answers,
        notes: info.notes,
        passCount, failCount, summary
      };
      saveRecord(rec);
      $("#saveMsg").classList.remove("hidden");
      setTimeout(() => $("#saveMsg").classList.add("hidden"), 2500);
      // reset form
      renderQuestions();
      $("#fxId").value = "";
      $("#fxLocation").value = "";
      $("#fxType").selectedIndex = 0;
      updateKPIs();
    }

    // ------------------ RECORDS RENDER ------------------
    function renderRecords() {
      const body = $("#recordsBody");
      const list = loadRecords().slice().reverse();
      body.innerHTML = "";
      list.forEach(r => {
        const fails = r.answers
          .map((a, i) => a === "‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô" ? `${i + 1}` : null)
          .filter(Boolean)
          .slice(0, 3)
          .join(", ");
        const tr = document.createElement("tr");
        tr.className = "border-t hover:bg-amber-50";
        tr.innerHTML = `
          <td class="p-2">${new Date(r.date).toLocaleString()}</td>
          <td class="p-2">${r.inspector}</td>
          <td class="p-2">${r.fxId || "-"}</td>
          <td class="p-2">${r.fxLocation || "-"}</td>
          <td class="p-2">${r.fxType || "-"}</td>
          <td class="p-2">${r.summary}</td>
          <td class="p-2">${fails || "-"}</td>
        `;
        body.appendChild(tr);
      });
    }

    // ------------------ EXPORT EXCEL ------------------
    function exportXLSX() {
      const rows = loadRecords();
      const data = rows.map(r => {
        const obj = {
          "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà": new Date(r.date).toLocaleString(),
          "‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à": r.inspector,
          "‡∏£‡∏´‡∏±‡∏™‡∏ñ‡∏±‡∏á": r.fxId,
          "‡∏à‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á": r.fxLocation,
          "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó": r.fxType,
          "‡∏™‡∏£‡∏∏‡∏õ": r.summary,
          "‡∏ú‡πà‡∏≤‡∏ô": r.passCount,
          "‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô": r.failCount,
        };
        QUESTIONS.forEach((q, i) => {
          obj[`Q${i+1} ${q}`] = r.answers[i] || "";
          if (r.answers[i] === "‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô") obj[`‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ Q${i+1}`] = r.notes[i] || "";
        });
        return obj;
      });
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "FE_Inspections");
      XLSX.writeFile(wb, `FE_Inspections_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    // ------------------ DASHBOARD ------------------
    let pieChart, barChart;
    function updateKPIs() {
      const list = loadRecords();
      const total = list.length;
      $("#kpiTotal").textContent = total;
      let passInspections = 0, failInspections = 0;
      list.forEach(r => {
        if (r.failCount === 0) passInspections++; else failInspections++;
      });
      const passRate = total ? Math.round((passInspections/total)*100) : 0;
      const failRate = total ? 100 - passRate : 0;
      $("#kpiPassRate").textContent = passRate + "%";
      $("#kpiFailRate").textContent = failRate + "%";
    }

    function drawDashboard() {
      updateKPIs();
      const list = loadRecords();
      const total = list.length;

      // Pie: pass vs fail (by inspection outcome)
      const passInspections = list.filter(r => r.failCount === 0).length;
      const failInspections = total - passInspections;
      const pieData = [passInspections, failInspections];

      if (pieChart) pieChart.destroy();
      pieChart = new Chart(document.getElementById("chartPie"), {
        type: "pie",
        data: {
          labels: ["‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", "‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô"],
          datasets: [{ data: pieData }]
        }
      });

      // Bar: most failed questions
      const failCounts = new Array(QUESTIONS.length).fill(0);
      list.forEach(r => r.answers.forEach((a, i) => { if (a === "‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô") failCounts[i]++; }));
      if (barChart) barChart.destroy();
      barChart = new Chart(document.getElementById("chartBar"), {
        type: "bar",
        data: {
          labels: QUESTIONS.map((_, i) => `Q${i+1}`),
          datasets: [{ label: "‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô", data: failCounts }]
        },
        options: { scales: { y: { beginAtZero: true } } }
      });
    }

    // ------------------ MANAGE USERS ------------------
    function renderUsers() {
      const ul = $("#userList");
      const users = loadUsers();
      ul.innerHTML = "";
      users.forEach((u, idx) => {
        const li = document.createElement("li");
        li.className = "flex items-center justify-between gap-2 p-2 rounded-lg hover:bg-slate-50";
        li.innerHTML = `
          <div>
            <span class="font-medium">${u.username}</span>
            <span class="ml-2 text-xs badge bg-slate-100 text-slate-700">${u.role}</span>
          </div>
          <div class="flex gap-2">
            <button class="px-2 py-1 text-xs rounded bg-amber-100 text-amber-800" data-act="reset" data-idx="${idx}">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™</button>
            <button class="px-2 py-1 text-xs rounded bg-rose-100 text-rose-800" data-act="del" data-idx="${idx}">‡∏•‡∏ö</button>
          </div>
        `;
        ul.appendChild(li);
      });
      ul.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          const idx = +btn.dataset.idx;
          const users = loadUsers();
          if (btn.dataset.act === "del") {
            if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${users[idx].username}?`)) return;
            users.splice(idx,1);
            saveUsers(users);
            renderUsers();
          } else if (btn.dataset.act === "reset") {
            const np = prompt("‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà");
            if (!np) return;
            users[idx].password = np;
            saveUsers(users);
            alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
          }
        });
      });
    }

    // ------------------ BACKUP/RESTORE ------------------
    function download(filename, text) {
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/json;charset=utf-8,' + encodeURIComponent(text));
      element.setAttribute('download', filename);
      element.style.display = 'none';
      document.body.appendChild(element);
      element.click();
      document.body.removeChild(element);
    }

    function backupJSON() {
      const data = {
        users: loadUsers(),
        records: loadRecords(),
      };
      download(`FEQ_backup_${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(data, null, 2));
    }

    function restoreJSON(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (data.users) localStorage.setItem(LS_USERS, JSON.stringify(data.users));
          if (data.records) localStorage.setItem(LS_RECORDS, JSON.stringify(data.records));
          alert("‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          location.reload();
        } catch (err) {
          alert("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        }
      };
      reader.readAsText(file);
    }

    // ------------------ INIT ------------------
    document.addEventListener("DOMContentLoaded", () => {
      // Render questions
      renderQuestions();

      // Tab buttons
      $$(".tabBtn").forEach(btn => btn.addEventListener("click", () => switchTab(btn.dataset.tab)));

      // Login
      $("#btnLogin").addEventListener("click", doLogin);
      $("#btnLogout").addEventListener("click", signOut);

      // Save record
      $("#btnSave").addEventListener("click", handleSave);

      // Records actions
      $("#btnExportXLSX").addEventListener("click", exportXLSX);
      $("#btnClear").addEventListener("click", () => {
        if (confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) {
          localStorage.removeItem(LS_RECORDS);
          renderRecords();
          updateKPIs();
        }
      });

      // Manage users
      $("#btnAddUser").addEventListener("click", () => {
        const u = $("#newUser").value.trim();
        const p = $("#newPass").value.trim();
        const r = $("#newRole").value;
        if (!u || !p) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô");
        const users = loadUsers();
        if (users.some(x => x.username === u)) return alert("‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß");
        users.push({ username: u, password: p, role: r });
        saveUsers(users);
        $("#newUser").value = ""; $("#newPass").value = ""; $("#newRole").value = "inspector";
        renderUsers();
      });

      $("#btnBackupJson").addEventListener("click", backupJSON);
      $("#btnRestoreJson").addEventListener("click", () => $("#restoreFile").click());
      $("#restoreFile").addEventListener("change", (e) => {
        const f = e.target.files[0]; if (f) restoreJSON(f);
      });

      // Auto session
      const sess = getSession();
      if (sess) afterLogin(sess);
    });
  </script>
</body>
</html>
